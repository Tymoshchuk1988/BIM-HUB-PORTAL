name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # –î–æ–∑–≤–æ–ª—è—î —Ä—É—á–Ω–∏–π –∑–∞–ø—É—Å–∫ –∑ GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass curl
        
    - name: Test SSH connection
      env:
        DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      run: |
        echo "Testing SSH connection..."
        sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "echo 'SSH connection successful'"
        
    - name: Run deployment script
      env:
        DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        echo "üöÄ Starting deployment..."
        
        # –°—Ç–≤–æ—Ä—é—î–º–æ —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—é
        cat > /tmp/deploy.sh << 'SCRIPT'
        #!/bin/bash
        PASSWORD="$DEPLOY_PASSWORD"
        HOST="$DEPLOY_HOST"
        USER="$DEPLOY_USER"
        REMOTE="$DEPLOY_PATH"
        LOCAL="./public_html"
        
        echo "Deploying from $(pwd)"
        
        # –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        upload() {
            local src="\$1"
            local dst="\$2"
            
            if sshpass -p "\$PASSWORD" scp -o StrictHostKeyChecking=no -r "\$src" "\$USER@\$HOST:\$dst" 2>/dev/null; then
                echo "‚úì \$(basename "\$src")"
                return 0
            else
                echo "‚úó \$(basename "\$src")"
                return 1
            fi
        }
        
        # –û—Å–Ω–æ–≤–Ω–∏–π –¥–µ–ø–ª–æ–π
        echo "Phase 1: Main files"
        upload "\$LOCAL/index.php" "\$REMOTE/"
        upload "\$LOCAL/login.php" "\$REMOTE/"
        upload "\$LOCAL/contact.php" "\$REMOTE/"
        upload "\$LOCAL/layout.php" "\$REMOTE/"
        upload "\$LOCAL/.htaccess" "\$REMOTE/"
        
        echo "Phase 2: Resources"
        upload "\$LOCAL/css/" "\$REMOTE/css/"
        upload "\$LOCAL/js/" "\$REMOTE/js/"
        upload "\$LOCAL/includes/" "\$REMOTE/includes/"
        
        echo "Phase 3: Pages"
        sshpass -p "\$PASSWORD" ssh -o StrictHostKeyChecking=no "\$USER@\$HOST" \
            "mkdir -p \$REMOTE/pages/{strategy,projects,library,education,team}"
        
        for page in strategy projects library education team; do
            upload "\$LOCAL/pages/\$page/index.php" "\$REMOTE/pages/\$page/"
        done
        
        echo "Phase 4: Permissions"
        sshpass -p "\$PASSWORD" ssh -o StrictHostKeyChecking=no "\$USER@\$HOST" "
            cd \$REMOTE
            find . -type d -exec chmod 755 {} \;
            find . -type f -exec chmod 644 {} \;
            echo 'Permissions updated'
        "
        
        echo "‚úÖ Deployment completed"
        SCRIPT
        
        chmod +x /tmp/deploy.sh
        /tmp/deploy.sh
        
    - name: Health check
      env:
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      run: |
        echo "Running health checks..."
        SITE_URL="https://bimhub.site"
        
        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≥–æ–ª–æ–≤–Ω–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        if curl -s -f "$SITE_URL" > /dev/null; then
          echo "‚úÖ Main page is accessible"
        else
          echo "‚ùå Main page is not accessible"
          exit 1
        fi
        
        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–æ—Ä—ñ–Ω–æ–∫
        for page in "" "pages/strategy/" "pages/projects/" "pages/library/" "pages/education/" "pages/team/" "contact.php"; do
          url="$SITE_URL/$page"
          status_code=$(curl -s -o /dev/null -w "%{http_code}" "$url")
          
          if [[ "$status_code" =~ ^(200|301|302)$ ]]; then
            echo "‚úÖ $url - $status_code"
          else
            echo "‚ùå $url - $status_code"
          fi
        done
        
    - name: Create deployment summary
      if: always()
      run: |
        echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üìä Deployment Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Code Checkout | ‚úÖ Success |" >> $GITHUB_STEP_SUMMARY
        echo "| SSH Connection | ‚úÖ Success |" >> $GITHUB_STEP_SUMMARY
        echo "| File Deployment | ‚úÖ Success |" >> $GITHUB_STEP_SUMMARY
        echo "| Health Checks | ‚úÖ Success |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üåê Site Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Main URL**: https://bimhub.site" >> $GITHUB_STEP_SUMMARY
        echo "- **Strategy**: https://bimhub.site/pages/strategy/" >> $GITHUB_STEP_SUMMARY
        echo "- **Projects**: https://bimhub.site/pages/projects/" >> $GITHUB_STEP_SUMMARY
        echo "- **Library**: https://bimhub.site/pages/library/" >> $GITHUB_STEP_SUMMARY
        echo "- **Education**: https://bimhub.site/pages/education/" >> $GITHUB_STEP_SUMMARY
        echo "- **Team**: https://bimhub.site/pages/team/" >> $GITHUB_STEP_SUMMARY
        echo "- **Contact**: https://bimhub.site/contact.php" >> $GITHUB_STEP_SUMMARY
        
    - name: Notify success
      if: success()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_TITLE: "‚úÖ BIM Hub Portal Deployed"
        SLACK_MESSAGE: "Successful deployment to production"
        SLACK_COLOR: "good"
        
    - name: Notify failure
      if: failure()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_TITLE: "‚ùå BIM Hub Portal Deployment Failed"
        SLACK_MESSAGE: "Check GitHub Actions for details"
        SLACK_COLOR: "danger"
