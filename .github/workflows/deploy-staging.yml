name: Deploy to Staging

on:
  push:
    branches:
      - develop
      - feature/*
  pull_request:
    branches:
      - develop

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup deployment environment
      env:
        STAGING_PASSWORD: ${{ secrets.STAGING_PASSWORD }}
        STAGING_HOST: ${{ secrets.STAGING_HOST }}
        STAGING_USER: ${{ secrets.STAGING_USER }}
        STAGING_PATH: ${{ secrets.STAGING_PATH }}
      run: |
        echo "Deploying to staging environment..."
        
        # Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ñ‚Ð¸Ð¼Ñ‡Ð°ÑÐ¾Ð²Ð¸Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´ÐµÐ¿Ð»Ð¾ÑŽ
        cat > deploy-staging.sh << 'SCRIPT'
        #!/bin/bash
        
        echo "ðŸš€ Deploying to Staging"
        echo "Host: \$STAGING_HOST"
        echo "Path: \$STAGING_PATH"
        
        # Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ñ–Ñ—
        sshpass -p "\$STAGING_PASSWORD" ssh -o StrictHostKeyChecking=no "\$STAGING_USER@\$STAGING_HOST" \
          "mkdir -p \$STAGING_PATH"
        
        # ÐšÐ¾Ð¿Ñ–ÑŽÐ²Ð°Ð½Ð½Ñ Ñ„Ð°Ð¹Ð»Ñ–Ð²
        echo "Copying files..."
        sshpass -p "\$STAGING_PASSWORD" scp -o StrictHostKeyChecking=no -r \
          ./public_html/* "\$STAGING_USER@\$STAGING_HOST:\$STAGING_PATH/"
        
        echo "âœ… Staging deployment completed"
        SCRIPT
        
        chmod +x deploy-staging.sh
        ./deploy-staging.sh
        
    - name: Generate staging URL
      if: success()
      run: |
        echo "## ðŸš€ Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Staging URL:** https://staging.bimhub.site" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
